CKEDITOR.dialog.add("link",function(v){var x,u;function p(a){return a.replace(/'/g,"\\$&")}function t(e){var d,g=x,c,a;d=[u,"("];for(var f=0;f<g.length;f++){c=g[f].toLowerCase(),a=e[c],0<f&&d.push(","),d.push("'",a?p(encodeURIComponent(e[c])):"","'")}d.push(")");return d.join("")}function G(a){for(var f,c=a.length,d=[],e=0;e<c;e++){f=a.charCodeAt(e),d.push(f)}return"String.fromCharCode("+d.join(",")+")"}function y(a){return(a=a.getAttribute("class"))?a.replace(/\s*(?:cke_anchor_empty|cke_anchor)(?:\s*$)?/g,""):""}var H=CKEDITOR.plugins.link,D=function(){var a=this.getDialog(),d=a.getContentElement("target","popupFeatures"),a=a.getContentElement("target","linkTargetName"),c=this.getValue();if(d&&a){switch(d=d.getElement(),d.hide(),a.setValue(""),c){case"frame":a.setLabel(v.lang.link.targetFrameName);a.getElement().show();break;case"popup":d.show();a.setLabel(v.lang.link.targetPopupName);a.getElement().show();break;default:a.setValue(c),a.getElement().hide()}}},q=/^javascript:/,n=/^mailto:([^?]+)(?:\?(.+))?$/,z=/subject=([^;?:@&=$,\/]*)/,B=/body=([^;?:@&=$,\/]*)/,l=/^#(.*)$/,E=/^((?:http|https|ftp|news):\/\/)?(.*)$/,r=/^(_(?:self|top|parent|blank))$/,j=/^javascript:void\(location\.href='mailto:'\+String\.fromCharCode\(([^)]+)\)(?:\+'(.*)')?\)$/,w=/^javascript:([^(]+)\(([^)]+)\)$/,m=/\s*window.open\(\s*this\.href\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*;\s*return\s*false;*\s*/,A=/(?:^|,)([^=]+)=(\d+|yes|no)/gi,C=function(J,g){var d=g&&(g.data("cke-saved-href")||g.getAttribute("href"))||"",e,f,c={};d.match(q)&&("encode"==k?d=d.replace(j,function(K,M,L){return"mailto:"+String.fromCharCode.apply(String,M.split(","))+(L&&L.replace(/\\'/g,"'"))}):k&&d.replace(w,function(O,P,Q){if(P==u){c.type="email";for(var O=c.email={},P=/(^')|('$)/g,Q=Q.match(/[^,\s]+/g),K=Q.length,M,L,N=0;N<K;N++){M=decodeURIComponent,L=Q[N].replace(P,"").replace(/\\'/g,"'"),L=M(L),M=x[N].toLowerCase(),O[M]=L}O.address=[O.name,O.domain].join("@")}}));if(!c.type){if(e=d.match(l)){c.type="anchor",c.anchor={},c.anchor.name=c.anchor.id=e[1]}else{if(e=d.match(n)){f=d.match(z);d=d.match(B);c.type="email";var h=c.email={};h.address=e[1];f&&(h.subject=decodeURIComponent(f[1]));d&&(h.body=decodeURIComponent(d[1]))}else{d&&(f=d.match(E))?(c.type="url",c.url={},c.url.protocol=f[1],c.url.url=f[2]):c.type="url"}}}if(g){e=g.getAttribute("target");c.target={};c.adv={};if(e){e.match(r)?c.target.type=c.target.name=e:(c.target.type="frame",c.target.name=e)}else{if(e=(e=g.data("cke-pa-onclick")||g.getAttribute("onclick"))&&e.match(m)){c.target.type="popup";for(c.target.name=e[1];d=A.exec(e[2]);){("yes"==d[2]||"1"==d[2])&&!(d[1] in {height:1,width:1,top:1,left:1})?c.target[d[1]]=!0:isFinite(d[2])&&(c.target[d[1]]=d[2])}}}e=function(M,K){var L=g.getAttribute(K);null!==L&&(c.adv[M]=L||"")};e("advId","id");e("advLangDir","dir");e("advAccessKey","accessKey");c.adv.advName=g.data("cke-saved-name")||g.getAttribute("name")||"";e("advLangCode","lang");e("advTabIndex","tabindex");e("advTitle","title");e("advContentType","type");CKEDITOR.plugins.link.synAnchorSelector?c.adv.advCSSClasses=y(g):e("advCSSClasses","class");e("advCharset","charset");e("advStyles","style");e("advRel","rel")}e=c.anchors=[];var a;if(CKEDITOR.plugins.link.emptyAnchorFix){h=J.document.getElementsByTag("a");d=0;for(f=h.count();d<f;d++){if(a=h.getItem(d),a.data("cke-saved-name")||a.hasAttribute("name")){e.push({name:a.data("cke-saved-name")||a.getAttribute("name"),id:a.getAttribute("id")})}}}else{h=new CKEDITOR.dom.nodeList(J.document.$.anchors);d=0;for(f=h.count();d<f;d++){a=h.getItem(d),e[d]={name:a.getAttribute("name"),id:a.getAttribute("id")}}}if(CKEDITOR.plugins.link.fakeAnchor){h=J.document.getElementsByTag("img");d=0;for(f=h.count();d<f;d++){(a=CKEDITOR.plugins.link.tryRestoreFakeAnchor(J,h.getItem(d)))&&e.push({name:a.getAttribute("name"),id:a.getAttribute("id")})}}this._.selectedElement=g;return c},o=function(a){a.target&&this.setValue(a.target[this.id]||"")},I=function(a){a.adv&&this.setValue(a.adv[this.id]||"")},b=function(a){a.target||(a.target={});a.target[this.id]=this.getValue()||""},i=function(a){a.adv||(a.adv={});a.adv[this.id]=this.getValue()||""},k=v.config.emailProtection||"";k&&"encode"!=k&&(u=x=void 0,k.replace(/^([^(]+)\(([^)]+)\)$/,function(c,d,a){u=d;x=[];a.replace(/[^,\s]+/g,function(e){x.push(e)})}));var F=v.lang.common,s=v.lang.link;return{title:s.title,minWidth:350,minHeight:230,contents:[{id:"info",label:s.info,title:s.info,elements:[{id:"linkType",type:"select",label:s.type,"default":"url",items:[[s.toUrl,"url"],[s.toAnchor,"anchor"],[s.toEmail,"email"]],onChange:function(){var e=this.getDialog(),f=["urlOptions","anchorOptions","emailOptions"],a=this.getValue(),c=e.definition.getContents("upload"),c=c&&c.hidden;if(a=="url"){v.config.linkShowTargetTab&&e.showPage("target");c||e.showPage("upload")}else{e.hidePage("target");c||e.hidePage("upload")}for(c=0;c<f.length;c++){var d=e.getContentElement("info",f[c]);if(d){d=d.getElement().getParent().getParent();f[c]==a+"Options"?d.show():d.hide()}}e.layout()},setup:function(a){a.type&&this.setValue(a.type)},commit:function(a){a.type=this.getValue()}},{type:"vbox",id:"urlOptions",children:[{type:"hbox",widths:["25%","75%"],children:[{id:"protocol",type:"select",label:F.protocol,"default":"http://",items:[["http://","http://"],["https://","https://"],["ftp://","ftp://"],["news://","news://"],[s.other,""]],setup:function(a){a.url&&this.setValue(a.url.protocol||"")},commit:function(a){if(!a.url){a.url={}}a.url.protocol=this.getValue()}},{type:"text",id:"url",label:F.url,required:!0,onLoad:function(){this.allowOnChange=true},onKeyUp:function(){this.allowOnChange=false;var d=this.getDialog().getContentElement("info","protocol"),e=this.getValue(),a=/^((javascript:)|[#\/\.\?])/i,c=/^(http|https|ftp|news):\/\/(?=.)/i.exec(e);if(c){this.setValue(e.substr(c[0].length));d.setValue(c[0].toLowerCase())}else{a.test(e)&&d.setValue("")}this.allowOnChange=true},onChange:function(){if(this.allowOnChange){this.onKeyUp()}},validate:function(){var a=this.getDialog();if(a.getContentElement("info","linkType")&&a.getValueOf("info","linkType")!="url"){return true}if(/javascript\:/.test(this.getValue())){alert(F.invalidValue);return false}return this.getDialog().fakeObj?true:CKEDITOR.dialog.validate.notEmpty(s.noUrl).apply(this)},setup:function(a){this.allowOnChange=false;a.url&&this.setValue(a.url.url);this.allowOnChange=true},commit:function(a){this.onChange();if(!a.url){a.url={}}a.url.url=this.getValue();this.allowOnChange=false}}],setup:function(){this.getDialog().getContentElement("info","linkType")||this.getElement().show()}},{type:"button",id:"browse",hidden:"true",filebrowser:"info:url",label:F.browseServer}]},{type:"vbox",id:"anchorOptions",width:260,align:"center",padding:0,children:[{type:"fieldset",id:"selectAnchorText",label:s.selectAnchor,setup:function(a){a.anchors.length>0?this.getElement().show():this.getElement().hide()},children:[{type:"hbox",id:"selectAnchor",children:[{type:"select",id:"anchorName","default":"",label:s.anchorName,style:"width: 100%;",items:[[""]],setup:function(a){this.clear();this.add("");for(var c=0;c<a.anchors.length;c++){a.anchors[c].name&&this.add(a.anchors[c].name)}a.anchor&&this.setValue(a.anchor.name);(a=this.getDialog().getContentElement("info","linkType"))&&a.getValue()=="email"&&this.focus()},commit:function(a){if(!a.anchor){a.anchor={}}a.anchor.name=this.getValue()}},{type:"select",id:"anchorId","default":"",label:s.anchorId,style:"width: 100%;",items:[[""]],setup:function(a){this.clear();this.add("");for(var c=0;c<a.anchors.length;c++){a.anchors[c].id&&this.add(a.anchors[c].id)}a.anchor&&this.setValue(a.anchor.id)},commit:function(a){if(!a.anchor){a.anchor={}}a.anchor.id=this.getValue()}}],setup:function(a){a.anchors.length>0?this.getElement().show():this.getElement().hide()}}]},{type:"html",id:"noAnchors",style:"text-align: center;",html:'<div role="note" tabIndex="-1">'+CKEDITOR.tools.htmlEncode(s.noAnchors)+"</div>",focus:!0,setup:function(a){a.anchors.length<1?this.getElement().show():this.getElement().hide()}}],setup:function(){this.getDialog().getContentElement("info","linkType")||this.getElement().hide()}},{type:"vbox",id:"emailOptions",padding:1,children:[{type:"text",id:"emailAddress",label:s.emailAddress,required:!0,validate:function(){var a=this.getDialog();return !a.getContentElement("info","linkType")||a.getValueOf("info","linkType")!="email"?true:CKEDITOR.dialog.validate.notEmpty(s.noEmail).apply(this)},setup:function(a){a.email&&this.setValue(a.email.address);(a=this.getDialog().getContentElement("info","linkType"))&&a.getValue()=="email"&&this.select()},commit:function(a){if(!a.email){a.email={}}a.email.address=this.getValue()}},{type:"text",id:"emailSubject",label:s.emailSubject,setup:function(a){a.email&&this.setValue(a.email.subject)},commit:function(a){if(!a.email){a.email={}}a.email.subject=this.getValue()}},{type:"textarea",id:"emailBody",label:s.emailBody,rows:3,"default":"",setup:function(a){a.email&&this.setValue(a.email.body)},commit:function(a){if(!a.email){a.email={}}a.email.body=this.getValue()}}],setup:function(){this.getDialog().getContentElement("info","linkType")||this.getElement().hide()}}]},{id:"target",requiredContent:"a[target]",label:s.target,title:s.target,elements:[{type:"hbox",widths:["50%","50%"],children:[{type:"select",id:"linkTargetType",label:F.target,"default":"notSet",style:"width : 100%;",items:[[F.notSet,"notSet"],[s.targetFrame,"frame"],[s.targetPopup,"popup"],[F.targetNew,"_blank"],[F.targetTop,"_top"],[F.targetSelf,"_self"],[F.targetParent,"_parent"]],onChange:D,setup:function(a){a.target&&this.setValue(a.target.type||"notSet");D.call(this)},commit:function(a){if(!a.target){a.target={}}a.target.type=this.getValue()}},{type:"text",id:"linkTargetName",label:s.targetFrameName,"default":"",setup:function(a){a.target&&this.setValue(a.target.name)},commit:function(a){if(!a.target){a.target={}}a.target.name=this.getValue().replace(/\W/gi,"")}}]},{type:"vbox",width:"100%",align:"center",padding:2,id:"popupFeatures",children:[{type:"fieldset",label:s.popupFeatures,children:[{type:"hbox",children:[{type:"checkbox",id:"resizable",label:s.popupResizable,setup:o,commit:b},{type:"checkbox",id:"status",label:s.popupStatusBar,setup:o,commit:b}]},{type:"hbox",children:[{type:"checkbox",id:"location",label:s.popupLocationBar,setup:o,commit:b},{type:"checkbox",id:"toolbar",label:s.popupToolbar,setup:o,commit:b}]},{type:"hbox",children:[{type:"checkbox",id:"menubar",label:s.popupMenuBar,setup:o,commit:b},{type:"checkbox",id:"fullscreen",label:s.popupFullScreen,setup:o,commit:b}]},{type:"hbox",children:[{type:"checkbox",id:"scrollbars",label:s.popupScrollBars,setup:o,commit:b},{type:"checkbox",id:"dependent",label:s.popupDependent,setup:o,commit:b}]},{type:"hbox",children:[{type:"text",widths:["50%","50%"],labelLayout:"horizontal",label:F.width,id:"width",setup:o,commit:b},{type:"text",labelLayout:"horizontal",widths:["50%","50%"],label:s.popupLeft,id:"left",setup:o,commit:b}]},{type:"hbox",children:[{type:"text",labelLayout:"horizontal",widths:["50%","50%"],label:F.height,id:"height",setup:o,commit:b},{type:"text",labelLayout:"horizontal",label:s.popupTop,widths:["50%","50%"],id:"top",setup:o,commit:b}]}]}]}]},{id:"upload",label:s.upload,title:s.upload,hidden:!0,filebrowser:"uploadButton",elements:[{type:"file",id:"upload",label:F.upload,style:"height:40px",size:29},{type:"fileButton",id:"uploadButton",label:F.uploadSubmit,filebrowser:"info:url","for":["upload","upload"]}]},{id:"advanced",label:s.advanced,title:s.advanced,elements:[{type:"vbox",padding:1,children:[{type:"hbox",widths:["45%","35%","20%"],children:[{type:"text",id:"advId",requiredContent:"a[id]",label:s.id,setup:I,commit:i},{type:"select",id:"advLangDir",requiredContent:"a[dir]",label:s.langDir,"default":"",style:"width:110px",items:[[F.notSet,""],[s.langDirLTR,"ltr"],[s.langDirRTL,"rtl"]],setup:I,commit:i},{type:"text",id:"advAccessKey",requiredContent:"a[accesskey]",width:"80px",label:s.acccessKey,maxLength:1,setup:I,commit:i}]},{type:"hbox",widths:["45%","35%","20%"],children:[{type:"text",label:s.name,id:"advName",requiredContent:"a[name]",setup:I,commit:i},{type:"text",label:s.langCode,id:"advLangCode",requiredContent:"a[lang]",width:"110px","default":"",setup:I,commit:i},{type:"text",label:s.tabIndex,id:"advTabIndex",requiredContent:"a[tabindex]",width:"80px",maxLength:5,setup:I,commit:i}]}]},{type:"vbox",padding:1,children:[{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:s.advisoryTitle,requiredContent:"a[title]","default":"",id:"advTitle",setup:I,commit:i},{type:"text",label:s.advisoryContentType,requiredContent:"a[type]","default":"",id:"advContentType",setup:I,commit:i}]},{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:s.cssClasses,requiredContent:"a(cke-xyz)","default":"",id:"advCSSClasses",setup:I,commit:i},{type:"text",label:s.charset,requiredContent:"a[charset]","default":"",id:"advCharset",setup:I,commit:i}]},{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:s.rel,requiredContent:"a[rel]","default":"",id:"advRel",setup:I,commit:i},{type:"text",label:s.styles,requiredContent:"a{cke-xyz}","default":"",id:"advStyles",validate:CKEDITOR.dialog.validate.inlineStyle(v.lang.common.invalidInlineStyle),setup:I,commit:i}]}]}]}],onShow:function(){var c=this.getParentEditor(),d=c.getSelection(),a=null;(a=H.getSelectedLink(c))&&a.hasAttribute("href")?d.selectElement(a):a=null;this.setupContent(C.apply(this,[c,a]))},onOk:function(){var d={},a=[],e={},f=this.getParentEditor();this.commitContent(e);switch(e.type||"url"){case"url":var g=e.url&&e.url.protocol!=void 0?e.url.protocol:"http://",K=e.url&&CKEDITOR.tools.trim(e.url.url)||"";d["data-cke-saved-href"]=K.indexOf("/")===0?K:g+K;break;case"anchor":g=e.anchor&&e.anchor.id;d["data-cke-saved-href"]="#"+(e.anchor&&e.anchor.name||g||"");break;case"email":var h=e.email,g=h.address;switch(k){case"":case"encode":var K=encodeURIComponent(h.subject||""),J=encodeURIComponent(h.body||""),h=[];K&&h.push("subject="+K);J&&h.push("body="+J);h=h.length?"?"+h.join("&"):"";if(k=="encode"){g=["javascript:void(location.href='mailto:'+",G(g)];h&&g.push("+'",p(h),"'");g.push(")")}else{g=["mailto:",g,h]}break;default:g=g.split("@",2);h.name=g[0];h.domain=g[1];g=["javascript:",t(h)]}d["data-cke-saved-href"]=g.join("")}if(e.target){if(e.target.type=="popup"){for(var g=["window.open(this.href, '",e.target.name||"","', '"],c=["resizable","status","location","toolbar","menubar","fullscreen","scrollbars","dependent"],K=c.length,h=function(L){e.target[L]&&c.push(L+"="+e.target[L])},J=0;J<K;J++){c[J]=c[J]+(e.target[c[J]]?"=yes":"=no")}h("width");h("left");h("height");h("top");g.push(c.join(","),"'); return false;");d["data-cke-pa-onclick"]=g.join("");a.push("target")}else{e.target.type!="notSet"&&e.target.name?d.target=e.target.name:a.push("target");a.push("data-cke-pa-onclick","onclick")}}if(e.adv){g=function(N,L){var M=e.adv[N];M?d[L]=M:a.push(L)};g("advId","id");g("advLangDir","dir");g("advAccessKey","accessKey");e.adv.advName?d.name=d["data-cke-saved-name"]=e.adv.advName:a=a.concat(["data-cke-saved-name","name"]);g("advLangCode","lang");g("advTabIndex","tabindex");g("advTitle","title");g("advContentType","type");g("advCSSClasses","class");g("advCharset","charset");g("advStyles","style");g("advRel","rel")}g=f.getSelection();d.href=d["data-cke-saved-href"];if(this._.selectedElement){f=this._.selectedElement;K=f.data("cke-saved-href");h=f.getHtml();f.setAttributes(d);f.removeAttributes(a);e.adv&&(e.adv.advName&&CKEDITOR.plugins.link.synAnchorSelector)&&f.addClass(f.getChildCount()?"cke_anchor":"cke_anchor_empty");if(K==h||e.type=="email"&&h.indexOf("@")!=-1){f.setHtml(e.type=="email"?e.email.address:d["data-cke-saved-href"])}g.selectElement(f);delete this._.selectedElement}else{g=g.getRanges(1)[0];if(g.collapsed){f=new CKEDITOR.dom.text(e.type=="email"?e.email.address:d["data-cke-saved-href"],f.document);g.insertNode(f);g.selectNodeContents(f)}f=new CKEDITOR.style({element:"a",attributes:d});f.type=CKEDITOR.STYLE_INLINE;f.applyToRange(g);g.select()}},onLoad:function(){v.config.linkShowAdvancedTab||this.hidePage("advanced");v.config.linkShowTargetTab||this.hidePage("target")},onFocus:function(){var a=this.getContentElement("info","linkType");if(a&&a.getValue()=="url"){a=this.getContentElement("info","url");a.select()}}}});